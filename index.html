<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Oklahoma Traffic Cameras Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #05060a;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    #map {
      flex: 1 1 auto;
    }

    /* Right side panel */
    #side-panel {
      width: 360px;
      max-width: 40%;
      background: #0b0d12;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
      gap: 8px;
    }

    #side-panel h1 {
      margin: 0 0 4px;
      font-size: 16px;
      font-weight: 600;
    }

    #side-panel p {
      margin: 0 0 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    #legend {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.sensor {
      background: #f97316; /* orange */
    }

    .legend-dot.video {
      background: #60a5fa; /* blue */
    }

    #m3u8-url {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      outline: none;
    }

    #m3u8-url:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.4);
    }

    #load-btn {
      margin-top: 4px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #ffffff;
      color: #020617;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
    }

    #load-btn:hover {
      filter: brightness(0.95);
    }

    #video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #020617;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #video-player,
    #snapshot-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    #status {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
      white-space: pre-wrap;
    }

    /* Leaflet popup tweaks */
    .leaflet-popup-content-wrapper {
      background: #020617;
      color: #e5e7eb;
      border-radius: 10px;
    }

    .leaflet-popup-tip {
      background: #020617;
    }

    .leaflet-container {
      background: #020617;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <aside id="side-panel">
      <h1>Oklahoma Traffic Cameras</h1>
      <p>
        Orange = sensor snapshot cameras (still image).<br>
        Blue = main video cameras (HLS m3u8 streams).
        Click a point to show its image or play its stream.
      </p>

      <div id="legend">
        <div class="legend-item">
          <span class="legend-dot sensor"></span>
          <span>Sensor snapshot</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot video"></span>
          <span>Video stream</span>
        </div>
      </div>

      <label for="m3u8-url" style="font-size:11px;font-weight:500;margin-top:6px;">m3u8 URL (manual override)</label>
      <input
        id="m3u8-url"
        type="text"
        placeholder="Paste an m3u8 link here and hit Load"
        value=""
      />
      <button id="load-btn">Load Stream</button>

      <div id="video-container">
        <img id="snapshot-image" alt="Snapshot" style="display:none;" />
        <video id="video-player" controls muted playsinline style="display:none;"></video>
      </div>

      <div id="status">Ready.</div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- hls.js for m3u8 playback in browsers that don't support it natively -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>

  <script>
    window.addEventListener('load', () => {
      const statusEl = document.getElementById('status');
      const videoEl = document.getElementById('video-player');
      const snapshotEl = document.getElementById('snapshot-image');
      const inputEl = document.getElementById('m3u8-url');
      const loadBtn = document.getElementById('load-btn');

      function setStatus(msg) {
        if (statusEl) statusEl.textContent = msg;
        console.log('[STATUS]', msg);
      }

      if (typeof L === 'undefined') {
        setStatus('Error: Leaflet failed to load (L is undefined). Check your internet or script URL.');
        return;
      }

      // 1) Initialize the Leaflet map
      const map = L.map('map', {
        zoomControl: true
      }).setView([35.5, -97.5], 7); // Rough center of Oklahoma

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // HLS / video player helpers
      let hlsInstance = null;

      function destroyHls() {
        if (hlsInstance) {
          hlsInstance.destroy();
          hlsInstance = null;
        }
      }

      function showSnapshot(url) {
        destroyHls();
        if (videoEl) {
          try { videoEl.pause(); } catch (e) {}
          videoEl.removeAttribute('src');
          videoEl.style.display = 'none';
        }
        if (snapshotEl) {
          snapshotEl.src = (url ? url : '');
          snapshotEl.style.display = url ? 'block' : 'none';
        }
      }

      function showVideo() {
        if (snapshotEl) snapshotEl.style.display = 'none';
        if (videoEl) videoEl.style.display = 'block';
      }

      function loadStream(url) {
        if (!url) {
          setStatus('Please paste an m3u8 URL first.');
          return;
        }

        if (!videoEl) {
          setStatus('Video element not found in DOM.');
          return;
        }

        showVideo();
        destroyHls();

        // Reset video element
        try {
          videoEl.pause();
        } catch (e) {}
        videoEl.removeAttribute('src');
        videoEl.load();

        setStatus('Loading stream...');

        // Native HLS support (Safari, some browsers)
        if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
          videoEl.src = url;
          videoEl.play().then(() => {
            setStatus('Playing (native HLS support).');
          }).catch((err) => {
            setStatus('Error starting playback: ' + err.message);
            console.error(err);
          });
          return;
        }

        // hls.js for others
        if (window.Hls && window.Hls.isSupported()) {
          hlsInstance = new Hls({ enableWorker: true });
          hlsInstance.loadSource(url);
          hlsInstance.attachMedia(videoEl);

          hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
            setStatus('Manifest parsed, starting playback...');
            videoEl.play().then(() => {
              setStatus('Playing m3u8 stream.');
            }).catch((err) => {
              setStatus('Error starting playback: ' + err.message);
              console.error(err);
            });
          });

          hlsInstance.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS.js error:', data);
            setStatus('HLS error: ' + (data && data.details ? data.details : 'unknown'));
          });
        } else {
          setStatus('This browser does not support HLS and hls.js is not available.');
        }
      }

      // Manual load button
      if (loadBtn) {
        loadBtn.addEventListener('click', () => {
          const url = (inputEl && inputEl.value || '').trim();
          loadStream(url);
        });
      }

      if (inputEl) {
        inputEl.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const url = (inputEl.value || '').trim();
            loadStream(url);
          }
        });
      }

      // 2) Load sensor + video GeoJSON
      const sensorUrl = 'https://raw.githubusercontent.com/anony121221/maps-data/refs/heads/main/Oklahoma/sensorcameras.geojson';
      const videoUrl = 'https://raw.githubusercontent.com/anony121221/maps-data/refs/heads/main/Oklahoma/oklahoma.geojson';

      Promise.all([
        fetch(sensorUrl).then((r) => {
          if (!r.ok) throw new Error('Sensor GeoJSON HTTP ' + r.status);
          return r.json();
        }),
        fetch(videoUrl).then((r) => {
          if (!r.ok) throw new Error('Video GeoJSON HTTP ' + r.status);
          return r.json();
        })
      ])
        .then(([sensorData, videoData]) => {
          // SENSOR CAMERAS (ORANGE + IMAGE)
          const sensorLayer = L.geoJSON(sensorData, {
            pointToLayer: (feature, latlng) =>
              L.circleMarker(latlng, {
                radius: 7,
                color: '#fb923c',
                fillColor: '#f97316',
                fillOpacity: 0.95,
                weight: 2
              }),
            onEachFeature: (feature, layer) => {
              const p = feature.properties || {};
              let img = p.imagePath;
              // Use proxy to bypass HTTPS mixed-content blocking
              if (img && img.startsWith('http://')) {
                img = 'https://corsproxy.io/?' + encodeURIComponent(img);
              }

              // Format UTC → CST helper
              const toCST = (utcString) => {
                try {
                  return new Date(utcString).toLocaleString('en-US', {
                    timeZone: 'America/Chicago',
                    hour12: true,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                  });
                } catch (e) {
                  return utcString;
                }
              };

              let html = `<div style='font-size:13px;line-height:1.35;'>`
              + `<strong>ID:</strong> ${p.id}<br>`
              + `<strong>Location:</strong> ${p.locationName}<br>`
              + `<strong>Temperature:</strong> ${p.temperature}°F<br>`
              + `<strong>Resolution:</strong> ${p.resolution}<br>`
              + `<strong>Last Updated (CST):</strong> ${toCST(p.updatedAt)}<br>`
              + `<strong>Picture Time (CST):</strong> ${toCST(p.pictureTime)}<br>`
              + `<br><img src='${img}' style='width:100%;border-radius:8px;'>`;
              html += `</div>`;
              layer.bindPopup(html);(html);(html || 'Sensor camera');

              layer.on('click', () => {
                if (img) {
                  showSnapshot(img);
                  setStatus('Showing sensor snapshot');
                } else {
                  setStatus('No snapshot image for this sensor.');
                }
              });
            }
          }).addTo(map);

          // VIDEO CAMERAS (BLUE + STREAM)
          const videoLayer = L.geoJSON(videoData, {
            pointToLayer: (feature, latlng) =>
              L.circleMarker(latlng, {
                radius: 7,
                color: '#3b82f6',
                fillColor: '#60a5fa',
                fillOpacity: 0.95,
                weight: 2
              }),
            onEachFeature: (feature, layer) => {
              const p = feature.properties || {};
              const stream = p.stream_url;

              let html = '';
              for (const [k, v] of Object.entries(p)) {
                html += `<strong>${k}</strong>: ${v}<br>`;
              }
              layer.bindPopup(html || 'Video camera');

              if (stream) {
                layer.on('click', () => {
                  if (inputEl) inputEl.value = stream;
                  loadStream(stream);
                  setStatus('Attempting to play video stream');
                });
              }
            }
          }).addTo(map);

          // Fit map to all features
          const allLatLngs = [];
          if (sensorData && sensorData.features) {
            sensorData.features.forEach((f) => {
              if (f.geometry && f.geometry.type === 'Point') {
                const [lon, lat] = f.geometry.coordinates;
                allLatLngs.push([lat, lon]);
              }
            });
          }
          if (videoData && videoData.features) {
            videoData.features.forEach((f) => {
              if (f.geometry && f.geometry.type === 'Point') {
                const [lon, lat] = f.geometry.coordinates;
                allLatLngs.push([lat, lon]);
              }
            });
          }
          if (allLatLngs.length > 0) {
            map.fitBounds(allLatLngs);
          }

          setStatus('Loaded sensor + video cameras.');
        })
        .catch((err) => {
          console.error('Error loading GeoJSON:', err);
          setStatus('Error loading GeoJSON: ' + err.message);
        });
    });
  </script>
</body>
</html>
