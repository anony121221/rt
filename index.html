<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Oklahoma GeoJSON + m3u8 Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #05060a;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #app {
      display: flex;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    #map {
      flex: 1 1 auto;
    }

    /* Right side panel for video */
    #side-panel {
      width: 360px;
      max-width: 40%;
      background: #0b0d12;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      padding: 12px;
      box-sizing: border-box;
      gap: 8px;
    }

    #side-panel h1 {
      margin: 0 0 4px;
      font-size: 16px;
      font-weight: 600;
    }

    #side-panel p {
      margin: 0 0 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    #m3u8-url {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      outline: none;
    }

    #m3u8-url:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.4);
    }

    #load-btn {
      margin-top: 4px;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #ffffff;
      color: #020617;
      font-weight: 600;
      font-size: 12px;
      cursor: pointer;
    }

    #load-btn:hover {
      filter: brightness(0.95);
    }

    #video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #020617;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 8px;
    }

    #video-player {
      width: 100%;
      height: 100%;
      background: #000;
    }

    #status {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
      white-space: pre-wrap;
    }

    /* Leaflet popup tweaks */
    .leaflet-popup-content-wrapper {
      background: #020617;
      color: #e5e7eb;
      border-radius: 10px;
    }

    .leaflet-popup-tip {
      background: #020617;
    }

    .leaflet-container {
      background: #020617;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <aside id="side-panel">
      <h1>Oklahoma GeoJSON + Stream</h1>
      <p>Left: Oklahoma polygons from your GeoJSON.
         Right: m3u8 video player (HLS) using hls.js.</p>

      <label for="m3u8-url" style="font-size:11px;font-weight:500;">m3u8 URL</label>
      <input
        id="m3u8-url"
        type="text"
        placeholder="Paste an m3u8 link here and hit Load"
        value=""
      />
      <button id="load-btn">Load Stream</button>

      <div id="video-container">
        <video id="video-player" controls muted playsinline></video>
      </div>

      <div id="status">Ready.</div>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-JcG8j6tP2Jb0C2lGkGixNqj0QmCw3j1u0Sx3C3p3p3s="
    crossorigin=""
  ></script>

  <!-- hls.js for m3u8 playback in browsers that don't support it natively -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>

  <script>
    // 1) Initialize the Leaflet map
    const map = L.map('map', {
      zoomControl: true
    }).setView([35.5, -97.5], 7); // Rough center of Oklahoma

    // Base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const geoJsonUrl = 'https://raw.githubusercontent.com/anony121221/maps-data/refs/heads/main/Oklahoma/combined_oklahoma.geojson';

    // 2) Load and render the GeoJSON as POINT MARKERS
    fetch(geoJsonUrl)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`GeoJSON HTTP error ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        const geoLayer = L.geoJSON(data, {
          pointToLayer: function (feature, latlng) {
            return L.circleMarker(latlng, {
              radius: 6,
              color: '#60a5fa',
              fillColor: '#1d4ed8',
              fillOpacity: 0.9,
              weight: 2
            });
          },
          onEachFeature: function (feature, layer) {
            const props = feature.properties || {};
            const stream = props.m3u8 || props.stream || props.url || null;

            let infoHtml = '';
            for (const [k, v] of Object.entries(props)) {
              infoHtml += `<strong>${k}</strong>: ${v}<br>`;
            }
            if (!infoHtml) infoHtml = 'No properties';

            layer.bindPopup(infoHtml);

            // CLICK loads the m3u8 feed
            if (stream) {
              layer.on('click', () => {
                input.value = stream;
                loadStream(stream);
                setStatus('Loaded from sensor click');
              });
            }
          }
        }).addTo(map);

        try {
          map.fitBounds(geoLayer.getBounds());
        } catch (err) {
          console.warn('Could not fit bounds:', err);
        }
      })
      .catch((err) => {
        console.error('Error loading GeoJSON:', err);
        document.getElementById('status').textContent = 'Error loading GeoJSON: ' + err.message;
      });

    // 3) m3u8 video player setup using hls.js
    const video = document.getElementById('video-player');
    const input = document.getElementById('m3u8-url');
    const loadBtn = document.getElementById('load-btn');
    const statusEl = document.getElementById('status');

    let hlsInstance = null;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function destroyHls() {
      if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
      }
    }

    function loadStream(url) {
      if (!url) {
        setStatus('Please paste an m3u8 URL first.');
        return;
      }

      destroyHls();
      video.pause();
      video.removeAttribute('src');
      video.load();

      setStatus('Loading stream...');

      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari and some browsers can handle HLS natively
        video.src = url;
        video.play().then(() => {
          setStatus('Playing (native HLS support).');
        }).catch((err) => {
          setStatus('Error starting playback: ' + err.message);
          console.error(err);
        });
      } else if (window.Hls && window.Hls.isSupported()) {
        // Use hls.js for other browsers
        hlsInstance = new Hls({
          enableWorker: true
        });

        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);

        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
          setStatus('Manifest parsed, starting playback...');
          video.play().then(() => {
            setStatus('Playing m3u8 stream.');
          }).catch((err) => {
            setStatus('Error starting playback: ' + err.message);
            console.error(err);
          });
        });

        hlsInstance.on(Hls.Events.ERROR, (event, data) => {
          console.error('HLS.js error:', data);
          setStatus('HLS error: ' + (data && data.details ? data.details : 'unknown'));
        });
      } else {
        setStatus('This browser does not support HLS natively and hls.js is not available.');
      }
    }

    loadBtn.addEventListener('click', () => {
      const url = input.value.trim();
      loadStream(url);
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        loadStream(input.value.trim());
      }
    });

    // Optional: if you have a default test URL, you can set it here.
    // input.value = 'https://example.com/your-stream.m3u8';
  </script>
</body>
</html>
