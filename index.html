<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oklahoma Traffic Cameras</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .popup-content { min-width: 340px; max-width: 420px; }
        .popup-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 8px; }
        .stream-container { width: 100%; height: 240px; margin: 12px 0; background: #000; border-radius: 6px; overflow: hidden; }
        .stream-iframe { width: 100%; height: 100%; border: none; }
        .sensor-image-container { width: 100%; margin: 12px 0; background: #f5f5f5; border-radius: 6px; overflow: hidden; text-align: center; min-height: 240px; display: flex; align-items: center; justify-content: center; }
        .sensor-image { max-width: 100%; max-height: 300px; display: block; margin: 0 auto; cursor: pointer; }
        .info-box { padding: 10px; background: #f5f5f5; border-radius: 4px; margin: 8px 0; font-size: 13px; }
        .info-row { margin: 4px 0; }
        .info-label { font-weight: bold; color: #555; }
        .button-link { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px; font-size: 13px; cursor: pointer; border: none; }
        .button-link:hover { background: #1976D2; }
        .message { padding: 12px; margin: 8px 0; border-radius: 4px; font-size: 13px; }
        .info-message { background: #e3f2fd; color: #1565c0; border-left: 3px solid #2196F3; }
        .warning-message { background: #fff3e0; color: #e65100; border-left: 3px solid #ff9800; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([35.5, -97.5], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        const streamIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background: #2196F3; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); font-size: 16px;">üìπ</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        const sensorIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background: #FF9800; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); font-size: 16px;">üì∑</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        function createStreamPopup(feature) {
            const props = feature.properties;
            const container = document.createElement('div');
            container.className = 'popup-content';
            
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = props.name || 'Traffic Camera';
            container.appendChild(title);

            if (props.stream_url) {
                // Create a simple HTML page for the iframe
                const iframeContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
                        <style>
                            body { margin: 0; background: #000; }
                            video { width: 100%; height: 100%; }
                            .error { color: white; padding: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <video id="video" controls autoplay muted></video>
                        <div id="error" class="error" style="display:none;">Stream loading...</div>
                        <script>
                            const video = document.getElementById('video');
                            const errorDiv = document.getElementById('error');
                            const streamUrl = '${props.stream_url}';
                            
                            if (Hls.isSupported()) {
                                const hls = new Hls();
                                hls.loadSource(streamUrl);
                                hls.attachMedia(video);
                                hls.on(Hls.Events.ERROR, function(event, data) {
                                    errorDiv.style.display = 'block';
                                    errorDiv.textContent = 'Stream unavailable';
                                });
                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                video.src = streamUrl;
                            }
                        </script>
                    </body>
                    </html>
                `;
                
                const streamDiv = document.createElement('div');
                streamDiv.className = 'stream-container';
                const iframe = document.createElement('iframe');
                iframe.className = 'stream-iframe';
                iframe.srcdoc = iframeContent;
                iframe.sandbox = 'allow-scripts allow-same-origin';
                streamDiv.appendChild(iframe);
                container.appendChild(streamDiv);
                
                const link = document.createElement('a');
                link.href = props.stream_url;
                link.target = '_blank';
                link.className = 'button-link';
                link.textContent = 'üîó Open Stream Directly';
                container.appendChild(link);
            }
            
            return container;
        }

        function createSensorPopup(feature) {
            const props = feature.properties;
            const container = document.createElement('div');
            container.className = 'popup-content';
            
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = `Sensor ${props.locationName || props.id}`;
            container.appendChild(title);

            const imagePath = props.latest_picture?.path;
            
            if (imagePath) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'sensor-image-container';
                imgContainer.innerHTML = '<div style="color: #666;">Loading image...</div>';
                
                // Try to load the image
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.className = 'sensor-image';
                
                img.onload = function() {
                    imgContainer.innerHTML = '';
                    img.onclick = () => window.open(imagePath, '_blank');
                    img.title = 'Click to open full size';
                    imgContainer.appendChild(img);
                };
                
                img.onerror = function() {
                    imgContainer.innerHTML = `
                        <div style="padding: 20px;">
                            <div class="warning-message">
                                Unable to load image directly due to browser security restrictions.
                            </div>
                            <a href="${imagePath}" target="_blank" class="button-link" style="display: block; margin-top: 10px;">
                                üñºÔ∏è Open Image in New Tab
                            </a>
                        </div>
                    `;
                };
                
                // Try both HTTP and HTTPS
                img.src = imagePath.replace('http://', 'https://');
                
                container.appendChild(imgContainer);
            }

            const infoBox = document.createElement('div');
            infoBox.className = 'info-box';
            
            if (props.id) {
                const idRow = document.createElement('div');
                idRow.className = 'info-row';
                idRow.innerHTML = `<span class="info-label">Sensor ID:</span> ${props.id}`;
                infoBox.appendChild(idRow);
            }
            
            if (props.temperature && props.temperature !== -40) {
                const tempRow = document.createElement('div');
                tempRow.className = 'info-row';
                tempRow.innerHTML = `<span class="info-label">Temperature:</span> ${props.temperature}¬∞F`;
                infoBox.appendChild(tempRow);
            }
            
            if (props.latest_picture?.time) {
                const timeRow = document.createElement('div');
                timeRow.className = 'info-row';
                const date = new Date(props.latest_picture.time);
                timeRow.innerHTML = `<span class="info-label">Last Update:</span> ${date.toLocaleString()}`;
                infoBox.appendChild(timeRow);
            }
            
            container.appendChild(infoBox);
            return container;
        }

        console.log('Loading cameras...');
        
        fetch(`https://raw.githubusercontent.com/anony121221/maps-data/refs/heads/main/Oklahoma/combined_oklahoma.geojson?t=${Date.now()}`)
            .then(r => r.json())
            .then(data => {
                let streamCount = 0, sensorCount = 0;
                
                L.geoJSON(data, {
                    pointToLayer: (feature, latlng) => {
                        const isSensor = feature.properties.type === 'sensor_camera';
                        if (isSensor) sensorCount++; else streamCount++;
                        return L.marker(latlng, { icon: isSensor ? sensorIcon : streamIcon });
                    },
                    onEachFeature: (feature, layer) => {
                        const isSensor = feature.properties.type === 'sensor_camera';
                        const popupContent = isSensor ? createSensorPopup(feature) : createStreamPopup(feature);
                        
                        layer.bindPopup(popupContent, { maxWidth: 450, minWidth: 340 });
                        
                        const tooltipText = isSensor ? 
                            `Sensor ${feature.properties.locationName}` : 
                            feature.properties.name;
                        
                        layer.bindTooltip(tooltipText, {
                            direction: 'top',
                            offset: [0, -15],
                            opacity: 0.9
                        });
                    }
                }).addTo(map);

                console.log(`‚úÖ Loaded ${data.features.length} cameras`);
                console.log(`   üìπ ${streamCount} video streams`);
                console.log(`   üì∑ ${sensorCount} sensor cameras`);
            })
            .catch(err => {
                console.error('‚ùå Error:', err);
                alert('Error loading camera data: ' + err.message);
            });

        const legend = L.control({position: 'bottomright'});
        legend.onAdd = () => {
            const div = L.DomUtil.create('div');
            div.style.cssText = 'background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 13px;';
            div.innerHTML = `
                <div style="margin-bottom: 8px; font-weight: bold;">Camera Types</div>
                <div style="margin-bottom: 6px;">üìπ Video Stream (${0} cameras)</div>
                <div>üì∑ Sensor Camera (${0} cameras)</div>
            `;
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
