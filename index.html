<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oklahoma Traffic Cameras</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .popup-content {
            min-width: 300px;
        }
        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .popup-info {
            margin-bottom: 8px;
            color: #666;
            font-size: 13px;
        }
        .video-container {
            width: 100%;
            margin: 10px 0;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
        }
        video {
            width: 100%;
            max-height: 240px;
            display: block;
        }
        .sensor-image {
            width: 100%;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error-message {
            color: #d32f2f;
            font-size: 12px;
            padding: 8px;
            background: #ffebee;
            border-radius: 4px;
            margin: 8px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .view-link {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
        }
        .view-link:hover {
            background: #1976D2;
        }
        .marker-label {
            background: white;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Initialize the map centered on Oklahoma
        const map = L.map('map').setView([35.5, -97.5], 7);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Custom icons for different camera types
        const streamIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background: #2196F3; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ðŸ“¹</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        const sensorIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background: #FF9800; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">ðŸ“·</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        // Function to create video player for m3u8 streams
        function createVideoPlayer(streamUrl) {
            const videoId = 'video-' + Math.random().toString(36).substr(2, 9);
            const container = document.createElement('div');
            container.className = 'video-container';
            container.innerHTML = `<video id="${videoId}" controls muted></video>`;
            
            setTimeout(() => {
                const video = document.getElementById(videoId);
                if (video && Hls.isSupported()) {
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play().catch(e => console.log('Autoplay prevented:', e));
                    });
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            console.error('HLS Error:', data);
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = streamUrl;
                    video.addEventListener('loadedmetadata', () => {
                        video.play().catch(e => console.log('Autoplay prevented:', e));
                    });
                }
            }, 100);
            
            return container;
        }

        // Function to create popup content for stream cameras
        function createStreamPopup(feature) {
            const props = feature.properties;
            const container = document.createElement('div');
            container.className = 'popup-content';
            
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = props.name || 'Traffic Camera';
            container.appendChild(title);

            if (props.stream_url) {
                const videoPlayer = createVideoPlayer(props.stream_url);
                container.appendChild(videoPlayer);
                
                const link = document.createElement('a');
                link.href = props.stream_url;
                link.target = '_blank';
                link.className = 'view-link';
                link.textContent = 'Open Stream in New Tab';
                container.appendChild(link);
            }
            
            return container;
        }

        // Function to create popup content for sensor cameras
        function createSensorPopup(feature) {
            const props = feature.properties;
            const container = document.createElement('div');
            container.className = 'popup-content';
            
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = props.locationName ? `Sensor ${props.locationName}` : 'Sensor Camera';
            container.appendChild(title);

            if (props.latest_picture && props.latest_picture.path) {
                const img = document.createElement('img');
                img.className = 'sensor-image';
                img.src = props.latest_picture.path;
                img.alt = 'Sensor Camera Image';
                img.onerror = function() {
                    this.style.display = 'none';
                    const error = document.createElement('div');
                    error.className = 'error-message';
                    error.textContent = 'Image unavailable';
                    container.appendChild(error);
                };
                container.appendChild(img);

                if (props.latest_picture.time) {
                    const time = document.createElement('div');
                    time.className = 'popup-info';
                    time.textContent = `Last Updated: ${new Date(props.latest_picture.time).toLocaleString()}`;
                    container.appendChild(time);
                }
            }

            if (props.temperature !== undefined) {
                const temp = document.createElement('div');
                temp.className = 'popup-info';
                temp.textContent = `Temperature: ${props.temperature}Â°F`;
                container.appendChild(temp);
            }

            const info = document.createElement('div');
            info.className = 'popup-info';
            info.textContent = `ID: ${props.id || 'N/A'}`;
            container.appendChild(info);
            
            return container;
        }

        // Load and display the GeoJSON data
        fetch('https://raw.githubusercontent.com/anony121221/maps-data/refs/heads/main/Oklahoma/combined_oklahoma.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    pointToLayer: function(feature, latlng) {
                        const isSensor = feature.properties.type === 'sensor_camera';
                        return L.marker(latlng, {
                            icon: isSensor ? sensorIcon : streamIcon
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        const isSensor = feature.properties.type === 'sensor_camera';
                        const popupContent = isSensor ? 
                            createSensorPopup(feature) : 
                            createStreamPopup(feature);
                        
                        layer.bindPopup(popupContent, {
                            maxWidth: 400,
                            minWidth: 300
                        });

                        // Add tooltip with name
                        const name = isSensor ? 
                            `Sensor ${feature.properties.locationName || feature.properties.id}` :
                            feature.properties.name;
                        
                        layer.bindTooltip(name, {
                            permanent: false,
                            direction: 'top',
                            offset: [0, -10]
                        });
                    }
                }).addTo(map);

                console.log(`Loaded ${data.features.length} cameras`);
            })
            .catch(error => {
                console.error('Error loading camera data:', error);
                alert('Error loading camera data. Please check the console for details.');
            });

        // Add legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.style.background = 'white';
            div.style.padding = '10px';
            div.style.borderRadius = '5px';
            div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            div.innerHTML = `
                <div style="margin-bottom: 5px;"><span style="color: #2196F3;">ðŸ“¹</span> Live Stream Camera</div>
                <div><span style="color: #FF9800;">ðŸ“·</span> Sensor Camera</div>
            `;
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
