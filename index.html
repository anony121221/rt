<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oklahoma Traffic Cameras</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .popup-content { min-width: 320px; max-width: 420px; }
        .popup-title { font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #333; border-bottom: 2px solid #2196F3; padding-bottom: 8px; }
        .popup-info { margin: 6px 0; color: #666; font-size: 13px; }
        .video-container { width: 100%; margin: 12px 0; background: #000; border-radius: 6px; overflow: hidden; position: relative; min-height: 240px; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 240px; display: block; }
        .sensor-image-container { width: 100%; margin: 12px 0; background: #f5f5f5; border-radius: 6px; overflow: hidden; text-align: center; }
        .sensor-image { width: 100%; display: block; cursor: pointer; }
        .error-message { color: #d32f2f; font-size: 12px; padding: 10px; background: #ffebee; border-radius: 4px; margin: 10px 0; }
        .loading { text-align: center; padding: 20px; color: #fff; font-style: italic; }
        .view-link { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #2196F3; color: white; text-decoration: none; border-radius: 4px; font-size: 13px; }
        .view-link:hover { background: #1976D2; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([35.5, -97.5], 7);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        const streamIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background: #2196F3; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); font-size: 16px;">ðŸ“¹</div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
        });

        const sensorIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background: #FF9800; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); font-size: 16px;">ðŸ“·</div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
        });

        function createVideoPlayer(streamUrl) {
            const videoId = 'video-' + Math.random().toString(36).substr(2, 9);
            const container = document.createElement('div');
            container.className = 'video-container';
            container.innerHTML = `
                <video id="${videoId}" controls playsinline crossorigin="anonymous"></video>
                <div class="loading">Loading stream...</div>
            `;
            
            setTimeout(() => {
                const video = document.getElementById(videoId);
                const loading = container.querySelector('.loading');
                
                if (!video) return;
                
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        enableWorker: true,
                        xhrSetup: function(xhr, url) {
                            xhr.withCredentials = false;
                        }
                    });
                    
                    hls.loadSource(streamUrl);
                    hls.attachMedia(video);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        if (loading) loading.style.display = 'none';
                        video.play().catch(e => console.log('Autoplay prevented'));
                    });
                    
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal && loading) {
                            loading.innerHTML = '<div class="error-message">Stream temporarily unavailable</div>';
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = streamUrl;
                    video.addEventListener('loadedmetadata', () => {
                        if (loading) loading.style.display = 'none';
                        video.play().catch(e => console.log('Autoplay prevented'));
                    });
                } else {
                    if (loading) loading.innerHTML = '<div class="error-message">Video not supported</div>';
                }
            }, 100);
            
            return container;
        }

        function createStreamPopup(feature) {
            const props = feature.properties;
            const container = document.createElement('div');
            container.className = 'popup-content';
            
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = props.name || 'Traffic Camera';
            container.appendChild(title);

            if (props.stream_url) {
                container.appendChild(createVideoPlayer(props.stream_url));
                
                const link = document.createElement('a');
                link.href = props.stream_url;
                link.target = '_blank';
                link.className = 'view-link';
                link.textContent = 'ðŸ”— Open Stream in New Tab';
                container.appendChild(link);
            }
            
            return container;
        }

        function createSensorPopup(feature) {
            const props = feature.properties;
            const container = document.createElement('div');
            container.className = 'popup-content';
            
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = `Sensor ${props.locationName || props.id}`;
            container.appendChild(title);

            // Use the path from latest_picture
            const imagePath = props.latest_picture?.path;
            
            if (imagePath) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'sensor-image-container';
                
                const img = document.createElement('img');
                img.className = 'sensor-image';
                img.src = imagePath;
                img.alt = 'Sensor Camera';
                img.onclick = () => window.open(imagePath, '_blank');
                img.onerror = function() {
                    imgContainer.innerHTML = '<div class="error-message">Image unavailable</div>';
                };
                
                imgContainer.appendChild(img);
                container.appendChild(imgContainer);
            }

            const infoGrid = document.createElement('div');
            infoGrid.className = 'info-grid';
            
            if (props.temperature && props.temperature !== -40) {
                const temp = document.createElement('div');
                temp.innerHTML = `<strong>Temperature:</strong> ${props.temperature}Â°F`;
                infoGrid.appendChild(temp);
            }
            
            if (props.latest_picture?.time) {
                const time = document.createElement('div');
                time.innerHTML = `<strong>Updated:</strong> ${new Date(props.latest_picture.time).toLocaleString()}`;
                infoGrid.appendChild(time);
            }
            
            container.appendChild(infoGrid);
            return container;
        }

        console.log('Loading cameras...');
        
        fetch(`https://raw.githubusercontent.com/anony121221/maps-data/refs/heads/main/Oklahoma/combined_oklahoma.geojson?t=${Date.now()}`)
            .then(r => r.json())
            .then(data => {
                let streamCount = 0, sensorCount = 0;
                
                L.geoJSON(data, {
                    pointToLayer: (feature, latlng) => {
                        const isSensor = feature.properties.type === 'sensor_camera';
                        if (isSensor) sensorCount++; else streamCount++;
                        return L.marker(latlng, { icon: isSensor ? sensorIcon : streamIcon });
                    },
                    onEachFeature: (feature, layer) => {
                        const isSensor = feature.properties.type === 'sensor_camera';
                        const popupContent = isSensor ? createSensorPopup(feature) : createStreamPopup(feature);
                        
                        layer.bindPopup(popupContent, { maxWidth: 420, minWidth: 320 });
                        layer.bindTooltip(
                            isSensor ? `Sensor ${feature.properties.locationName}` : feature.properties.name,
                            { direction: 'top', offset: [0, -15], opacity: 0.9 }
                        );
                    }
                }).addTo(map);

                console.log(`Loaded ${data.features.length} cameras (${streamCount} streams, ${sensorCount} sensors)`);
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error loading camera data');
            });

        const legend = L.control({position: 'bottomright'});
        legend.onAdd = () => {
            const div = L.DomUtil.create('div');
            div.style.cssText = 'background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 13px;';
            div.innerHTML = `
                <div style="margin-bottom: 8px; font-weight: bold;">Camera Types</div>
                <div style="margin-bottom: 6px;">ðŸ“¹ Live Stream</div>
                <div>ðŸ“· Sensor Camera</div>
            `;
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>
